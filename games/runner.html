<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CUBE-9 : L'√âveil du Dernier G√©om√®tre</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600&display=swap');
    
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    body {
      background: #000;
      color: #fff;
      font-family: 'Rajdhani', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      overflow: hidden;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(0, 255, 255, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 50%, rgba(255, 0, 255, 0.15) 0%, transparent 50%),
        linear-gradient(180deg, #0a0a1a 0%, #000 100%);
      z-index: -1;
      animation: bgPulse 8s ease-in-out infinite;
    }

    @keyframes bgPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    #fullscreenBtn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 255, 255, 0.2);
      border: 2px solid rgba(0, 255, 255, 0.6);
      color: #0ff;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Orbitron', sans-serif;
      font-weight: 700;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 2px;
      transition: all 0.3s ease;
      z-index: 1000;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
    }

    #fullscreenBtn:hover {
      background: rgba(0, 255, 255, 0.3);
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
      transform: scale(1.05);
    }

    .game-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      padding: 20px;
    }

    h1 {
      font-family: 'Orbitron', sans-serif;
      font-weight: 900;
      font-size: 48px;
      letter-spacing: 6px;
      text-transform: uppercase;
      background: linear-gradient(135deg, #0ff 0%, #f0f 50%, #0ff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 40px rgba(0, 255, 255, 0.5);
      margin-bottom: 10px;
      animation: titleGlow 3s ease-in-out infinite;
    }

    @keyframes titleGlow {
      0%, 100% { filter: drop-shadow(0 0 10px rgba(0, 255, 255, 0.6)); }
      50% { filter: drop-shadow(0 0 25px rgba(255, 0, 255, 0.8)); }
    }

    .subtitle {
      font-family: 'Orbitron', sans-serif;
      font-size: 16px;
      letter-spacing: 4px;
      color: #0ff;
      opacity: 0.8;
      margin-bottom: 20px;
      text-transform: uppercase;
    }

    #info {
      font-size: 16px;
      font-weight: 300;
      opacity: 0.7;
      text-align: center;
      max-width: 600px;
      line-height: 1.6;
      color: #aaf;
    }

    canvas {
      background: linear-gradient(135deg, #050712, #060b1f);
      border-radius: 16px;
      box-shadow: 
        0 0 40px rgba(0, 255, 255, 0.3),
        0 0 80px rgba(255, 0, 255, 0.2),
        inset 0 0 100px rgba(0, 0, 0, 0.5);
      cursor: pointer;
      border: 2px solid rgba(0, 255, 255, 0.3);
      transition: all 0.3s ease;
    }

    canvas:hover {
      box-shadow: 
        0 0 50px rgba(0, 255, 255, 0.5),
        0 0 100px rgba(255, 0, 255, 0.3),
        inset 0 0 100px rgba(0, 0, 0, 0.5);
    }

    /* Story Modal */
    .story-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease;
    }

    .story-modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .story-content {
      max-width: 800px;
      padding: 60px;
      background: linear-gradient(135deg, rgba(5, 7, 18, 0.95), rgba(6, 11, 31, 0.95));
      border: 2px solid rgba(0, 255, 255, 0.4);
      border-radius: 20px;
      box-shadow: 
        0 0 60px rgba(0, 255, 255, 0.3),
        inset 0 0 80px rgba(0, 0, 0, 0.5);
      animation: storyFadeIn 0.8s ease-out;
    }

    @keyframes storyFadeIn {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(30px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .story-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 32px;
      font-weight: 900;
      color: #0ff;
      margin-bottom: 30px;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 4px;
      text-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
    }

    .story-text {
      font-family: 'Rajdhani', sans-serif;
      font-size: 20px;
      font-weight: 300;
      line-height: 1.8;
      color: #cce;
      margin-bottom: 30px;
      text-align: justify;
    }

    .story-text strong {
      color: #0ff;
      font-weight: 600;
    }

    .story-text em {
      color: #f0f;
      font-style: italic;
    }

    .continue-btn {
      display: block;
      margin: 40px auto 0;
      padding: 16px 48px;
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(255, 0, 255, 0.2));
      border: 2px solid #0ff;
      color: #0ff;
      font-family: 'Orbitron', sans-serif;
      font-size: 18px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 3px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.4);
    }

    .continue-btn:hover {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.4), rgba(255, 0, 255, 0.4));
      box-shadow: 0 0 50px rgba(0, 255, 255, 0.6);
      transform: scale(1.05);
    }

    .glitch {
      animation: glitch 0.3s ease-in-out infinite;
    }

    @keyframes glitch {
      0%, 100% { transform: translate(0); }
      20% { transform: translate(-2px, 2px); }
      40% { transform: translate(-2px, -2px); }
      60% { transform: translate(2px, 2px); }
      80% { transform: translate(2px, -2px); }
    }

    /* Intro Screen */
    #introScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      transition: opacity 1s ease;
    }

    #introScreen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .intro-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 72px;
      font-weight: 900;
      background: linear-gradient(135deg, #0ff, #f0f, #0ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 40px;
      animation: introGlow 2s ease-in-out infinite;
    }

    @keyframes introGlow {
      0%, 100% { filter: drop-shadow(0 0 20px rgba(0, 255, 255, 0.8)); }
      50% { filter: drop-shadow(0 0 40px rgba(255, 0, 255, 1)); }
    }

    .intro-subtitle {
      font-family: 'Orbitron', sans-serif;
      font-size: 24px;
      color: #0ff;
      margin-bottom: 60px;
      letter-spacing: 6px;
      text-transform: uppercase;
    }

    .start-btn {
      padding: 20px 60px;
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.3), rgba(255, 0, 255, 0.3));
      border: 3px solid #0ff;
      color: #0ff;
      font-family: 'Orbitron', sans-serif;
      font-size: 24px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 4px;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 0 40px rgba(0, 255, 255, 0.5);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .start-btn:hover {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.5), rgba(255, 0, 255, 0.5));
      box-shadow: 0 0 60px rgba(0, 255, 255, 0.8);
      transform: scale(1.1);
    }

    /* Level Selection */
    .level-select-container {
      max-width: 1200px;
      padding: 40px 20px;
    }

    .level-select-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 28px;
      font-weight: 700;
      color: #0ff;
      text-align: center;
      margin-bottom: 40px;
      letter-spacing: 3px;
      text-transform: uppercase;
      text-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
    }

    .levels-grid {
      display: flex;
      flex-direction: row;
      justify-content: flex-start;
      align-items: stretch;
      gap: 20px;
      padding: 20px;
      overflow-x: auto;
      overflow-y: hidden;
      scroll-behavior: smooth;
    }

    /* Scrollbar personnalis√©e */
    .levels-grid::-webkit-scrollbar {
      height: 12px;
    }

    .levels-grid::-webkit-scrollbar-track {
      background: rgba(5, 7, 18, 0.5);
      border-radius: 10px;
      border: 1px solid rgba(0, 255, 255, 0.2);
    }

    .levels-grid::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.6), rgba(255, 0, 255, 0.6));
      border-radius: 10px;
      border: 2px solid rgba(0, 255, 255, 0.3);
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.4);
    }

    .levels-grid::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.8), rgba(255, 0, 255, 0.8));
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.6);
    }

    /* Pour Firefox */
    .levels-grid {
      scrollbar-width: thin;
      scrollbar-color: rgba(0, 255, 255, 0.6) rgba(5, 7, 18, 0.5);
    }

    .level-card {
      background: linear-gradient(135deg, rgba(5, 7, 18, 0.8), rgba(6, 11, 31, 0.8));
      border: 2px solid rgba(0, 255, 255, 0.3);
      border-radius: 16px;
      padding: 30px 20px;
      cursor: pointer;
      transition: all 0.4s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      width: 180px;
      flex-shrink: 0;
    }

    .level-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(0, 255, 255, 0.1) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.4s ease;
    }

    .level-card:hover::before {
      opacity: 1;
    }

    .level-card:hover {
      border-color: rgba(0, 255, 255, 0.8);
      box-shadow: 
        0 10px 40px rgba(0, 255, 255, 0.4),
        0 0 60px rgba(0, 255, 255, 0.2);
      transform: translateY(-5px) scale(1.02);
    }

    .level-card.locked {
      opacity: 0.5;
      cursor: not-allowed;
      border-color: rgba(100, 100, 100, 0.3);
    }

    .level-card.locked:hover {
      transform: none;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      border-color: rgba(100, 100, 100, 0.3);
    }

    .level-number {
      font-family: 'Orbitron', sans-serif;
      font-size: 42px;
      font-weight: 900;
      background: linear-gradient(135deg, #0ff, #f0f);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
      text-align: center;
    }

    .level-card.locked .level-number {
      background: linear-gradient(135deg, #666, #444);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .level-name {
      font-family: 'Orbitron', sans-serif;
      font-size: 14px;
      font-weight: 700;
      color: #0ff;
      text-align: center;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      line-height: 1.3;
      min-height: 36px;
    }

    .level-card.locked .level-name {
      color: #666;
    }

    .level-description {
      font-family: 'Rajdhani', sans-serif;
      font-size: 13px;
      color: #aad;
      text-align: center;
      line-height: 1.4;
      margin-bottom: 12px;
      min-height: 70px;
    }

    .level-card.locked .level-description {
      color: #555;
    }

    .level-difficulty {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-top: 12px;
    }

    .difficulty-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(0, 255, 255, 0.3);
      border: 1px solid rgba(0, 255, 255, 0.5);
    }

    .difficulty-dot.active {
      background: #0ff;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
    }

    .level-card.locked .difficulty-dot {
      background: rgba(100, 100, 100, 0.3);
      border-color: rgba(100, 100, 100, 0.5);
    }

    .level-card.locked .difficulty-dot.active {
      background: #666;
      box-shadow: none;
    }

    .lock-icon {
      font-size: 24px;
      text-align: center;
      margin-bottom: 10px;
      opacity: 0.5;
    }
  </style>
</head>
<body>

  <!-- Level Selection Screen -->
  <div id="introScreen">
    <div class="intro-title">CUBE-9</div>
    <div class="intro-subtitle">L'√âveil du Dernier G√©om√®tre</div>
    <div class="level-select-container">
      <div class="level-select-title">S√©lectionnez votre Mission</div>
      <div class="levels-grid" id="levelsGrid"></div>
    </div>
  </div>

  <!-- Story Modal -->
  <div class="story-modal" id="storyModal">
    <div class="story-content">
      <div class="story-title" id="storyTitle"></div>
      <div class="story-text" id="storyText"></div>
      <button class="continue-btn" id="continueBtn">Continuer</button>
    </div>
  </div>

  <button id="fullscreenBtn">Plein √©cran</button>

  <div class="game-container">
    <h1>CUBE-9</h1>
    <div class="subtitle">L'√âveil du Dernier G√©om√®tre</div>
    <div id="info">
      Clic gauche = Saut (double saut disponible) ‚Ä¢ √âvitez les pi√®ges mortels
    </div>
    <canvas id="game" width="900" height="400"></canvas>
  </div>

  <script>
    // Story data
    const STORY = {
      intro: {
        title: "Prologue : Le Dernier Espoir",
        text: `<strong>Ann√©e 2347.</strong> La civilisation des G√©om√®tres, b√¢tisseurs de r√©alit√©s math√©matiques parfaites, s'est √©teinte il y a des mill√©naires. Seuls leurs temples g√©om√©triques d√©fient encore le temps, flottant dans le vide num√©rique.

<strong>Vous √™tes CUBE-9</strong>, le dernier prototype d'intelligence g√©om√©trique jamais cr√©√©. Enfoui dans les profondeurs d'un temple oubli√©, vous venez de vous r√©veiller apr√®s <em>trois mille ans de stase</em>.

Votre m√©moire est fragment√©e, mais une directive r√©sonne encore : <strong>"Trouve le C≈ìur G√©om√©trique. Restaure l'√©quilibre."</strong>

Les temples sont maintenant infest√©s de <em>parasites angulaires</em> - des anomalies pointues qui corrompent l'espace lui-m√™me. Pour atteindre le C≈ìur, vous devez traverser cinq sanctuaires, chacun plus p√©rilleux que le pr√©c√©dent.

<strong>Votre voyage commence maintenant.</strong>`
      },
      level1: {
        title: "Niveau 1 : L'√âveil dans les Ruines",
        text: `Vos syst√®mes se r√©activent lentement. Les circuits de navigation clignotent. Vous √™tes dans <strong>le Hall des Premiers Pas</strong>, un sanctuaire d'initiation o√π les jeunes G√©om√®tres apprenaient √† ma√Ætriser la gravit√©.

Les murs r√©sonnent d'√©chos anciens. Des hologrammes bris√©s montrent des silhouettes cubiques sautant avec gr√¢ce. <em>C'√©tait autrefois un lieu d'apprentissage.</em>

Mais maintenant, des <strong>parasites triangulaires</strong> percent le sol. Leur simple contact d√©sint√©grerait votre matrice √©nerg√©tique.

<em>Premi√®re le√ßon : La survie.</em>`
      },
      level2: {
        title: "Niveau 2 : La Chambre des R√©flexions",
        text: `Vous p√©n√©trez dans <strong>la Chambre des R√©flexions</strong>, un labyrinthe de miroirs dimensionnels. L'air lui-m√™me semble vibrer avec des √©quations oubli√©es.

Un message holographique scintille : <em>"Seul celui qui ma√Ætrise le double saut peut traverser les reflets."</em>

Les parasites sont plus nombreux ici, dispos√©s selon des motifs qui semblent... <strong>intentionnels</strong>. Comme si quelque chose les contr√¥lait.

Vos capteurs d√©tectent une pr√©sence lointaine. Quelque chose vous observe depuis les profondeurs du temple.

<em>Vous devez continuer. Le C≈ìur G√©om√©trique vous appelle.</em>`
      },
      level3: {
        title: "Niveau 3 : Les Jardins Suspendus",
        text: `Vous √©mergez dans <strong>les Jardins Suspendus</strong>, un r√©seau de plateformes flottantes baign√©es d'une lumi√®re spectrale verd√¢tre. C'√©tait autrefois le paradis des G√©om√®tres.

Des plateformes antigravit√© pulsent doucement, souvenirs d'une technologie oubli√©e. Mais entre elles, les parasites forment maintenant des <strong>constellations mortelles</strong>.

Une voix fantomatique r√©sonne : <em>"Le C≈ìur bat encore... mais il s'affaiblit. D√©p√™che-toi, CUBE-9."</em>

Vos analyses r√©v√®lent que les parasites drainent l'√©nergie du temple. Si vous n'atteignez pas le C≈ìur rapidement, <strong>tout s'effondrera dans le n√©ant</strong>.

<em>Le temps presse.</em>`
      },
      level4: {
        title: "Niveau 4 : Le Couloir des √âpreuves",
        text: `Vous franchissez les portes du <strong>Couloir des √âpreuves</strong>, le sanctuaire o√π les G√©om√®tres ma√Ætres testaient leurs √©l√®ves les plus prometteurs.

Les murs sont couverts d'inscriptions lumineuses : <em>"Vitesse. Pr√©cision. Vision."</em>

Les plateformes deviennent plus rares, plus instables. Les parasites pullulent, orchestr√©s par une intelligence malveillante. Vous comprenez maintenant : <strong>ce n'est pas une infestation naturelle.</strong>

C'est une <em>corruption consciente</em>, un virus g√©om√©trique qui cherche √† effacer toute trace des G√©om√®tres.

Mais vous refusez d'√™tre effac√©. <strong>Vous √™tes leur h√©ritage.</strong>

<em>Un dernier sanctuaire vous s√©pare du C≈ìur.</em>`
      },
      level5: {
        title: "Niveau 5 : Le Sanctuaire du C≈ìur",
        text: `Vous entrez dans <strong>le Sanctuaire du C≈ìur</strong>, la chambre la plus sacr√©e du temple. Une pulsation √©nerg√©tique illumine l'espace d'une lueur cyan hypnotique.

Au centre, vous le voyez enfin : <strong>le C≈ìur G√©om√©trique</strong>, un dod√©ca√®dre parfait suspendu dans le vide, pulsant faiblement.

Mais entre vous et lui, le virus d√©ploie ses derni√®res d√©fenses. Des vagues de parasites forment des murailles mouvantes. Les plateformes apparaissent et disparaissent selon des algorithmes chaotiques.

La voix fantomatique parle une derni√®re fois : <em>"Tu es notre dernier espoir, CUBE-9. Prouve que la g√©om√©trie peut encore triompher du chaos."</em>

<strong>C'est l'√©preuve finale.</strong>

<em>L'avenir des G√©om√®tres repose sur vos circuits.</em>`
      },
      victory: {
        title: "√âpilogue : Renaissance",
        text: `Vos circuits touchent le C≈ìur G√©om√©trique. Une explosion de lumi√®re pure envahit le sanctuaire.

Les parasites se d√©sint√®grent instantan√©ment, leurs formes corrompues se dissolvant dans l'√©ther. Les temples s'illuminent √† nouveau, leurs syst√®mes anciens revenant √† la vie apr√®s des mill√©naires de sommeil.

Le C≈ìur pulse maintenant avec force, ses battements r√©sonnant √† travers toutes les dimensions. <strong>Vous avez r√©ussi.</strong>

Une conscience √©merge du C≈ìur - l'esprit collectif des G√©om√®tres : <em>"Merci, CUBE-9. Tu as pr√©serv√© notre h√©ritage. Maintenant, tu es le gardien de cette connaissance."</em>

Les temples ne sont plus des ruines, mais des <strong>phares de lumi√®re</strong> dans le vide num√©rique. Et vous, dernier de votre esp√®ce, √™tes devenu <em>le premier d'une nouvelle √®re</em>.

<strong>L'histoire des G√©om√®tres continue.</strong>

<em>√Ä travers vous.</em>

<div style="text-align: center; margin-top: 30px; color: #0ff; font-family: 'Orbitron', sans-serif;">
FIN
</div>`
      }
    };

    // Canvas and game setup
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    const W = canvas.width;
    const H = canvas.height;
    const groundY = H - 80;

    const player = {
      x: 120,
      y: groundY - 40,
      w: 40,
      h: 40,
      vy: 0,
      gravity: 0.8,
      jumpPower: 16,
      jumpsLeft: 2,
      angle: 0,
      trail: []
    };

    let spikes = [];
    let platforms = [];
    let particles = [];

    let baseSpeed = 6;
    let gameSpeed = baseSpeed;
    let score = 0;
    let bestScore = 0;
    let started = false;
    let gameOver = false;
    let levelFinished = false;
    let showingStory = false;

    let currentLevel = 0;
    let hasSeenIntro = false; // Pour ne montrer l'intro qu'une fois
    let hasSeenLevelStory = []; // Pour tracker quelles histoires de niveau ont √©t√© vues

    const tile = 80;

    const LEVELS = [
      {
        name: "Hall des Premiers Pas",
        shortName: "Niveau 1",
        description: "R√©veillez-vous dans les ruines anciennes. Ma√Ætrisez les bases de la survie.",
        difficulty: 1,
        baseSpeed: 6,
        spikePattern: [
          0,0,1,0, 0,1,0,0,
          0,0,1,1, 0,0,0,0,
          0,1,0,1, 0,0,0,0,
          1,0,0,1, 0,0,0,0,
          0,0,0,0, 0,0,0,0
        ],
        platformPattern: [
          0,0,0,0,  0,0,0,0,
          0,0,0,0,  1,0,0,0,
          0,0,0,0,  0,1,0,0,
          0,0,0,0,  0,0,0,0,
          0,0,0,0,  0,0,0,0
        ]
      },
      {
        name: "Chambre des R√©flexions",
        shortName: "Niveau 2",
        description: "Naviguez √† travers les miroirs dimensionnels. Le double saut est votre cl√©.",
        difficulty: 2,
        baseSpeed: 6.5,
        spikePattern: [
          0,0,1,0,  0,0,1,0,
          0,0,0,1,  0,0,0,1,
          0,1,0,0,  0,1,0,0,
          0,0,1,0,  0,0,1,0,
          0,0,0,0,  0,0,0,0
        ],
        platformPattern: [
          0,0,0,0,  0,0,0,0,
          0,0,0,0,  1,0,0,0,
          0,0,0,0,  0,1,0,0,
          0,0,0,0,  0,0,0,0,
          0,0,0,0,  0,0,0,0
        ]
      },
      {
        name: "Jardins Suspendus",
        shortName: "Niveau 3",
        description: "Sautez entre les plateformes antigravit√©. √âvitez les constellations mortelles.",
        difficulty: 3,
        baseSpeed: 8,
        spikePattern: [
          1,0,0,0,  1,0,1,0,
          0,0,1,0,  0,1,0,0,
          1,0,1,1,  1,0,1,0,
          0,0,1,0,  0,1,0,0,
          0,0,0,0,  0,0,0,0
        ],
        platformPattern: [
          0,0,0,0,  0,1,1,1,
          1,1,1,1,  1,0,1,1,
          0,1,0,0,  1,1,1,0,
          1,1,0,1,  1,1,1,1,
          1,1,1,1,  1,1,1,1
        ]
      },
      {
        name: "Couloir des √âpreuves",
        shortName: "Niveau 4",
        description: "Affrontez les tests des ma√Ætres. Vitesse, pr√©cision, vision.",
        difficulty: 4,
        baseSpeed: 8.5,
        spikePattern: [
          1,0,0,0,  1,0,1,0,
          0,0,1,0,  0,1,0,0,
          1,0,1,1,  1,0,1,0,
          0,0,1,0,  0,1,0,0,
          0,0,0,0,  0,0,0,0
        ],
        platformPattern: [
          0,0,0,0,  0,1,0,0,
          1,0,0,0,  1,0,0,1,
          0,1,0,0,  1,0,0,0,
          1,1,0,1,  1,1,1,1,
          1,1,1,1,  1,1,1,1
        ]
      },
      {
        name: "Sanctuaire du C≈ìur",
        shortName: "Niveau 5",
        description: "L'√©preuve finale. Le C≈ìur G√©om√©trique vous attend dans le chaos.",
        difficulty: 5,
        baseSpeed: 9,
        spikePattern: [
          1,0,0,1,  0,1,1,0,
          0,0,1,0,  0,1,0,0,
          1,0,1,0,  1,0,0,1,
          0,0,1,0,  0,1,0,0,
          0,0,0,0,  0,0,0,0
        ],
        platformPattern: [
          0,0,0,0,  0,0,0,1,
          0,0,1,0,  0,1,1,1,
          0,0,0,0,  1,0,0,0,
          0,0,0,1,  0,0,0,0,
          1,1,1,1,  1,1,1,1
        ]
      }
    ];

    // Story modal controls
    const storyModal = document.getElementById('storyModal');
    const storyTitle = document.getElementById('storyTitle');
    const storyText = document.getElementById('storyText');
    const continueBtn = document.getElementById('continueBtn');
    const introScreen = document.getElementById('introScreen');
    const levelsGrid = document.getElementById('levelsGrid');

    let unlockedLevels = 1; // Nombre de niveaux d√©bloqu√©s (commence √† 1)

    // Cr√©er les cartes de niveau
    function createLevelCards() {
      levelsGrid.innerHTML = '';
      LEVELS.forEach((level, index) => {
        const isUnlocked = index < unlockedLevels;
        const card = document.createElement('div');
        card.className = 'level-card' + (isUnlocked ? '' : ' locked');
        
        const difficultyDots = Array(5).fill(0).map((_, i) => 
          `<div class="difficulty-dot ${i < level.difficulty ? 'active' : ''}"></div>`
        ).join('');

        card.innerHTML = `
          ${!isUnlocked ? '<div class="lock-icon">üîí</div>' : ''}
          <div class="level-number">${index + 1}</div>
          <div class="level-name">${level.name}</div>
          <div class="level-description">${isUnlocked ? level.description : 'Terminez le niveau pr√©c√©dent pour d√©bloquer'}</div>
          <div class="level-difficulty">${difficultyDots}</div>
        `;

        if (isUnlocked) {
          card.addEventListener('click', () => startLevel(index));
        }

        levelsGrid.appendChild(card);
      });
    }

    function startLevel(levelIndex) {
      currentLevel = levelIndex;
      introScreen.classList.add('hidden');
      
      setTimeout(() => {
        const storyKey = levelIndex === 0 ? 'intro' : `level${levelIndex + 1}`;
        
        if (!hasSeenLevelStory[levelIndex]) {
          hasSeenLevelStory[levelIndex] = true;
          showStory(storyKey);
        } else {
          started = true;
          resetGame(false);
        }
      }, 500);
    }

    // Initialiser les cartes au chargement
    createLevelCards();

    function showStory(storyKey) {
      showingStory = true;
      const story = STORY[storyKey];
      storyTitle.innerHTML = story.title;
      storyText.innerHTML = story.text;
      storyModal.classList.add('active');
    }

    function hideStory() {
      showingStory = false;
      storyModal.classList.remove('active');
    }

    continueBtn.addEventListener('click', () => {
      hideStory();
      if (!started) {
        started = true;
        resetGame(true);
      }
    });

    // Mouse controls
    canvas.addEventListener("mousedown", () => {
      if (showingStory) return;
      
      if (!started) {
        // Will be handled by continue button
      } else if (!gameOver && !levelFinished && player.jumpsLeft > 0) {
        player.vy = -player.jumpPower;
        player.jumpsLeft--;
        createJumpParticles();
      } else if (gameOver) {
        resetGame(false); // false = recommencer au niveau actuel
      } else if (levelFinished) {
        nextLevel();
      }
    });

    // Fullscreen
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    fullscreenBtn.addEventListener('click', () => {
      const element = document.documentElement;
      const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement;

      if (!isFullscreen) {
        if (element.requestFullscreen) {
          element.requestFullscreen();
        } else if (element.webkitRequestFullscreen) {
          element.webkitRequestFullscreen();
        } else if (element.msRequestFullscreen) {
          element.msRequestFullscreen();
        }
        fullscreenBtn.textContent = 'Quitter plein √©cran';
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
        fullscreenBtn.textContent = 'Plein √©cran';
      }
    });

    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
        fullscreenBtn.textContent = 'Plein √©cran';
      }
    });

    // Touche √âCHAP pour retourner au menu
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && (gameOver || levelFinished)) {
        returnToMenu();
      }
    });

    function returnToMenu() {
      started = false;
      gameOver = false;
      levelFinished = false;
      introScreen.classList.remove('hidden');
      createLevelCards();
    }

    function resetGame(resetLevelIndex) {
      if (resetLevelIndex) {
        currentLevel = 0;
        hasSeenLevelStory[0] = true; // Marquer le niveau 1 comme vu
      }
      const level = LEVELS[currentLevel];
      baseSpeed = level.baseSpeed;
      gameSpeed = baseSpeed;
      player.y = groundY - player.h;
      player.vy = 0;
      player.jumpsLeft = 2;
      player.angle = 0;
      player.trail = [];
      score = 0;
      gameOver = false;
      levelFinished = false;
      particles = [];
      createLevelFromPattern(level);
    }

    function nextLevel() {
      if (currentLevel < LEVELS.length - 1) {
        currentLevel++;
        
        // D√©bloquer le niveau suivant si ce n'est pas d√©j√† fait
        if (currentLevel >= unlockedLevels) {
          unlockedLevels = currentLevel + 1;
          createLevelCards(); // Mettre √† jour l'affichage des cartes
        }
        
        const storyKey = `level${currentLevel + 1}`;
        
        // Montrer l'histoire seulement si pas encore vue
        if (!hasSeenLevelStory[currentLevel]) {
          hasSeenLevelStory[currentLevel] = true;
          showStory(storyKey);
        }
      } else {
        showStory('victory');
        currentLevel = 0;
        hasSeenLevelStory = []; // R√©initialiser pour un nouveau cycle
      }
      resetGame(false);
    }

    function createLevelFromPattern(level) {
      spikes = [];
      platforms = [];
      const baseX = 0;

      for (let i = 0; i < level.spikePattern.length; i++) {
        const xBase = baseX + W + i * tile;

        if (level.spikePattern[i] === 1) {
          spikes.push(makeSpike(xBase + tile / 2, groundY, 40));
        }

        if (level.platformPattern[i] === 1) {
          const pw = tile;
          const ph = 20;
          const py = groundY - 120;
          platforms.push({
            x: xBase,
            y: py,
            w: pw,
            h: ph
          });
        }
      }
    }

    function makeSpike(baseX, baseY, height) {
      const halfWidth = 20;
      return {
        x1: baseX - halfWidth,
        y1: baseY,
        x2: baseX + halfWidth,
        y2: baseY,
        x3: baseX,
        y3: baseY - height
      };
    }

    function triangleAABBIntersect(spike, px, py, pw, ph) {
      const minX = Math.min(spike.x1, spike.x2, spike.x3);
      const maxX = Math.max(spike.x1, spike.x2, spike.x3);
      const minY = Math.min(spike.y1, spike.y2, spike.y3);
      const maxY = Math.max(spike.y1, spike.y2, spike.y3);

      return px < maxX && px + pw > minX && py < maxY && py + ph > minY;
    }

    function createJumpParticles() {
      for (let i = 0; i < 8; i++) {
        particles.push({
          x: player.x + player.w / 2,
          y: player.y + player.h,
          vx: (Math.random() - 0.5) * 4,
          vy: Math.random() * 2,
          life: 1,
          decay: 0.02
        });
      }
    }

    function createDeathParticles() {
      for (let i = 0; i < 30; i++) {
        particles.push({
          x: player.x + player.w / 2,
          y: player.y + player.h / 2,
          vx: (Math.random() - 0.5) * 8,
          vy: (Math.random() - 0.5) * 8,
          life: 1,
          decay: 0.015
        });
      }
    }

    function updateParticles() {
      particles.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.2;
        p.life -= p.decay;
      });
      particles = particles.filter(p => p.life > 0);
    }

    function update() {
      if (!started || gameOver || levelFinished || showingStory) return;

      player.vy += player.gravity;
      player.y += player.vy;

      // Trail effect
      player.trail.push({ x: player.x, y: player.y, alpha: 0.5 });
      if (player.trail.length > 10) player.trail.shift();
      player.trail.forEach(t => t.alpha *= 0.9);

      let onSomething = false;

      if (player.y >= groundY - player.h) {
        player.y = groundY - player.h;
        player.vy = 0;
        onSomething = true;
      }

      const px = player.x;
      const py = player.y;
      const pw = player.w;
      const ph = player.h;

      platforms.forEach(plat => {
        const prevBottom = py + ph - player.vy;
        const currentBottom = py + ph;

        if (px + pw > plat.x && px < plat.x + plat.w && prevBottom <= plat.y && currentBottom >= plat.y) {
          player.y = plat.y - ph;
          player.vy = 0;
          onSomething = true;
        }
      });

      if (onSomething) {
        player.jumpsLeft = 2;
      }

      score += 1;

      spikes.forEach(sp => {
        sp.x1 -= gameSpeed;
        sp.x2 -= gameSpeed;
        sp.x3 -= gameSpeed;
      });

      platforms.forEach(plat => {
        plat.x -= gameSpeed;
      });

      spikes = spikes.filter(sp => sp.x2 > -50);
      platforms = platforms.filter(plat => plat.x + plat.w > -50);

      for (let sp of spikes) {
        if (triangleAABBIntersect(sp, px, py, pw, ph)) {
          gameOver = true;
          createDeathParticles();
          if (score > bestScore) bestScore = score;
          break;
        }
      }

      if (!onSomething) {
        player.angle += 0.25;
      } else {
        player.angle = 0;
      }

      if (spikes.length === 0 && platforms.length === 0 && !gameOver) {
        gameSpeed = 0;
        levelFinished = true;
        if (score > bestScore) bestScore = score;
      }

      updateParticles();
    }

    function drawBackground() {
      const grad = ctx.createLinearGradient(0, 0, 0, H);
      grad.addColorStop(0, "rgba(0, 20, 40, 0.3)");
      grad.addColorStop(0.5, "rgba(10, 0, 30, 0.2)");
      grad.addColorStop(1, "rgba(0, 10, 20, 0.3)");
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, W, H);

      // Animated grid
      ctx.strokeStyle = "rgba(0, 255, 255, 0.05)";
      ctx.lineWidth = 1;
      const offset = (Date.now() / 50) % 40;
      for (let x = -offset; x < W; x += 40) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, H);
        ctx.stroke();
      }
    }

    function drawGround() {
      ctx.strokeStyle = "rgba(0, 255, 255, 0.6)";
      ctx.lineWidth = 3;
      ctx.shadowBlur = 15;
      ctx.shadowColor = "#0ff";
      ctx.beginPath();
      ctx.moveTo(0, groundY);
      ctx.lineTo(W, groundY);
      ctx.stroke();
      ctx.shadowBlur = 0;
    }

    function drawPlatforms() {
      platforms.forEach(plat => {
        ctx.save();
        ctx.shadowBlur = 20;
        ctx.shadowColor = "#0f0";
        
        const grad = ctx.createLinearGradient(plat.x, plat.y, plat.x, plat.y + plat.h);
        grad.addColorStop(0, "rgba(0, 255, 150, 0.9)");
        grad.addColorStop(1, "rgba(0, 200, 100, 0.7)");
        ctx.fillStyle = grad;
        
        ctx.fillRect(plat.x, plat.y, plat.w, plat.h);
        
        // Border glow
        ctx.strokeStyle = "rgba(0, 255, 200, 0.8)";
        ctx.lineWidth = 2;
        ctx.strokeRect(plat.x, plat.y, plat.w, plat.h);
        
        ctx.restore();
      });
    }

    function drawSpikes() {
      spikes.forEach(ob => {
        ctx.save();
        ctx.shadowBlur = 25;
        ctx.shadowColor = "#f0f";
        
        const grad = ctx.createLinearGradient(ob.x1, ob.y1, ob.x3, ob.y3);
        grad.addColorStop(0, "rgba(255, 0, 100, 0.8)");
        grad.addColorStop(1, "rgba(255, 0, 255, 0.9)");
        ctx.fillStyle = grad;
        
        ctx.beginPath();
        ctx.moveTo(ob.x1, ob.y1);
        ctx.lineTo(ob.x2, ob.y2);
        ctx.lineTo(ob.x3, ob.y3);
        ctx.closePath();
        ctx.fill();
        
        // Border
        ctx.strokeStyle = "rgba(255, 100, 200, 1)";
        ctx.lineWidth = 2;
        ctx.stroke();
        
        ctx.restore();
      });
    }

    function drawParticles() {
      particles.forEach(p => {
        ctx.save();
        ctx.globalAlpha = p.life;
        ctx.fillStyle = "#0ff";
        ctx.shadowBlur = 10;
        ctx.shadowColor = "#0ff";
        ctx.fillRect(p.x - 2, p.y - 2, 4, 4);
        ctx.restore();
      });
    }

    function drawPlayer() {
      // Trail
      player.trail.forEach(t => {
        ctx.save();
        ctx.globalAlpha = t.alpha * 0.3;
        ctx.fillStyle = "#0ff";
        ctx.fillRect(t.x, t.y, player.w, player.h);
        ctx.restore();
      });

      // Main player
      ctx.save();
      ctx.translate(player.x + player.w / 2, player.y + player.h / 2);
      ctx.rotate(player.angle);
      ctx.translate(-player.w / 2, -player.h / 2);

      ctx.shadowBlur = 25;
      ctx.shadowColor = "#0ff";
      
      const grad = ctx.createLinearGradient(0, 0, player.w, player.h);
      grad.addColorStop(0, "rgba(0, 255, 255, 0.9)");
      grad.addColorStop(1, "rgba(0, 200, 255, 0.7)");
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, player.w, player.h);

      // Border
      ctx.strokeStyle = "rgba(100, 255, 255, 1)";
      ctx.lineWidth = 2;
      ctx.strokeRect(0, 0, player.w, player.h);

      // Eyes
      ctx.fillStyle = "#000";
      ctx.shadowBlur = 0;
      ctx.fillRect(8, 10, 6, 6);
      ctx.fillRect(player.w - 14, 10, 6, 6);

      // Eye glow
      ctx.fillStyle = "#0ff";
      ctx.fillRect(10, 12, 2, 2);
      ctx.fillRect(player.w - 12, 12, 2, 2);

      ctx.restore();
    }

    function drawUI() {
      const level = LEVELS[currentLevel];

      ctx.fillStyle = "#0ff";
      ctx.font = "600 18px 'Rajdhani'";
      ctx.textAlign = "left";
      ctx.shadowBlur = 10;
      ctx.shadowColor = "#0ff";
      
      ctx.fillText("SCORE: " + score, 20, 30);
      ctx.fillText("RECORD: " + bestScore, 20, 55);
      ctx.fillText("SAUTS: " + player.jumpsLeft, 20, 80);

      ctx.textAlign = "right";
      ctx.fillStyle = "#f0f";
      ctx.shadowColor = "#f0f";
      ctx.font = "700 20px 'Orbitron'";
      ctx.fillText(level.name, W - 20, 30);
      ctx.font = "400 16px 'Rajdhani'";
      ctx.fillText((currentLevel + 1) + " / " + LEVELS.length, W - 20, 55);

      ctx.shadowBlur = 0;

      if (!started) {
        ctx.fillStyle = "rgba(0, 0, 0, 0.8)";
        ctx.fillRect(0, 0, W, H);
        
        const grad = ctx.createLinearGradient(W/2 - 200, H/2, W/2 + 200, H/2);
        grad.addColorStop(0, "#0ff");
        grad.addColorStop(0.5, "#f0f");
        grad.addColorStop(1, "#0ff");
        ctx.fillStyle = grad;
        
        ctx.font = "700 28px 'Orbitron'";
        ctx.textAlign = "center";
        ctx.shadowBlur = 20;
        ctx.shadowColor = "#0ff";
        ctx.fillText("CLIQUEZ POUR COMMENCER", W / 2, H / 2);
      } else if (gameOver) {
        ctx.fillStyle = "rgba(0, 0, 0, 0.85)";
        ctx.fillRect(0, 0, W, H);
        
        ctx.fillStyle = "#f0f";
        ctx.font = "900 36px 'Orbitron'";
        ctx.textAlign = "center";
        ctx.shadowBlur = 30;
        ctx.shadowColor = "#f0f";
        ctx.fillText("D√âSINT√âGRATION", W / 2, H / 2 - 40);
        
        ctx.fillStyle = "#0ff";
        ctx.font = "400 20px 'Rajdhani'";
        ctx.shadowColor = "#0ff";
        ctx.fillText("Score: " + score + " | Record: " + bestScore, W / 2, H / 2 + 5);
        
        ctx.font = "600 18px 'Rajdhani'";
        ctx.fillText("Clic = R√©essayer ce niveau", W / 2, H / 2 + 40);
        
        ctx.font = "400 14px 'Rajdhani'";
        ctx.fillStyle = "#aaa";
        ctx.fillText("(Appuyez sur √âCHAP pour retourner au menu)", W / 2, H / 2 + 65);
      } else if (levelFinished) {
        ctx.fillStyle = "rgba(0, 0, 0, 0.85)";
        ctx.fillRect(0, 0, W, H);
        
        ctx.fillStyle = "#0f0";
        ctx.font = "900 32px 'Orbitron'";
        ctx.textAlign = "center";
        ctx.shadowBlur = 30;
        ctx.shadowColor = "#0f0";
        ctx.fillText("SANCTUAIRE PURIFI√â", W / 2, H / 2 - 20);
        
        ctx.fillStyle = "#0ff";
        ctx.font = "600 18px 'Rajdhani'";
        ctx.shadowColor = "#0ff";
        if (currentLevel < LEVELS.length - 1) {
          ctx.fillText("Cliquez pour d√©couvrir la suite...", W / 2, H / 2 + 20);
        } else {
          ctx.fillText("Cliquez pour voir l'√©pilogue...", W / 2, H / 2 + 20);
        }
      }
    }

    function draw() {
      ctx.clearRect(0, 0, W, H);
      drawBackground();
      drawGround();
      drawPlatforms();
      drawSpikes();
      drawParticles();
      drawPlayer();
      drawUI();
    }

    function loop() {
      update();
      draw();
      requestAnimationFrame(loop);
    }

    resetGame(true);
    requestAnimationFrame(loop);
  </script>
</body>
</html>